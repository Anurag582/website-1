---
title: "spatial movement data"
author: "Carl Boettiger"
date: "6/13/2017"
output: html_document
---

See:

- <http://robinlovelace.net/geocompr/index.html>
- <https://cran.r-project.org/web/packages/sf/vignettes/sf1.html>
- <https://cran.r-project.org/web/packages/sf/vignettes/sf2.html>
- <http://strimas.com/r/tidy-sf/>



```{r message=FALSE}
library(sf)
library(tidyverse)

library(maps)    # for low-res country maps
library(mapdata) # for higher-res country maps
```



Consdier spatio-temporal data with `stars` package: 

```{r}
#devtools::install_github("r-spatial/stars", update = FALSE)

```

Buffalo movement data from <http://dx.doi.org/10.5441/001/1.j900f88t>


```{r message=FALSE}
#buffalo_meta <- read_csv("https://www.datarepository.movebank.org/bitstream/handle/10255/move.611/Kruger%20African%20Buffalo%2c%20GPS%20tracking%2c%20South%20Africa-reference-data.csv")

buffalo_meta <- read_csv("../data/buffalo-meta.csv")
```

```{r}
#buffalo <- read_csv("https://www.datarepository.movebank.org/bitstream/handle/10255/move.610/Kruger%20African%20Buffalo%2c%20GPS%20tracking%2c%20South%20Africa.csv")

buffalo <- read_csv("../data/buffalo.csv")
buffalo
```

```{r}
buffalo_sf <- st_as_sf(buffalo, coords = c("location-long", "location-lat"), crs=4326)
```

```{r}
buffalo_sf %>% filter(`individual-local-identifier`=="Queen", timestamp < as.POSIXct("2005-05-01")) %>%
  ggplot() + geom_sf(size=0.2, shape="+")
```

Note: also see maps in `spData` package.  

```{r}
#sa <- map("worldHires","South Africa", plot=FALSE)
st_as_sf(map('world', "South Africa", plot = FALSE, fill = TRUE, xlim = c(14,35), ylim=c(-35,-20))) %>% 
  st_transform(4326) %>%
  ggplot() + geom_sf() 
```


```{r}
download.file("http://biogeo.ucdavis.edu/data/gadm2.8/shp/ZAF_adm_shp.zip", "sa.shp.zip")
unzip("sa.shp.zip", exdir = "sa.shp")
```



```{r}
south_africa <- st_read("sa.shp")
south_africa %>% 
  ggplot() + geom_sf()
```

```{r}
b <- st_bbox(buffalo_sf)
```

```{r}
kruger <- south_africa %>% filter(NAME_1 %in% c("Limpopo", "Mpumalanga"))

buffalo_sf %>% 
  filter(`individual-local-identifier`=="Queen") %>%
  filter(timestamp < as.POSIXct("2005-05-01")) %>%
  ggplot()  + 
  geom_sf(data = kruger) +
  geom_sf()  # map first, pts on top
  #coord_sf(xlim = c(31.6,32), ylim = c(-25, -24))
  #coord_sf(xlim = c(b['xmin'], b['xmax']), ylim = c(b['ylim'], b['ymax']))
```


----------


```{r}
p4s <- "+init=epsg:4326 +proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs +towgs84=0,0,0"
```

- `sf`: a Simple Feature data.frame
- `sfc`: Simple Feature column, containing the geometry of a simple feature frame.
- `sfg`: a Simple Feature Geometry

Hack cooridnates into WKT format to exploit conversion from CSV

```{r}
buffalo %>%
  rename(X = `location-lat`, Y = `location-long`) %>%
  mutate(WKT = paste0("POINT (", X, " ", Y, ")")) %>%
  select(-X, -Y) %>%
  write_csv("buffalo_st.csv")
buffalo_st <- st_read("buffalo_st.csv")

st_crs(buffalo_st) <- p4s

```


Construct a `sf` data.frame manually? See https://github.com/edzer/sfr/issues/385

```{r}

#buffalo %>% rowwise() %>% summarise(long = `location-long`, lat=`location-lat`)

## better than purrrlyr::by_rows
## need dplyr >= 0.7.0 to support list-columns

buffalo_sf <-
buffalo %>%
  rowwise() %>%
  mutate(geometry = 
           st_geometry(
             st_point(c(`location-long`, `location-lat`)))) %>% 
  ungroup() # remove rowwise class

as(buffalo_sf, "sf")
# 
# class(buffalo_sf) <- c("sf", class(buffalo_sf))

## errors:
#st_crs(buffalo_sf) <- p4s
```

Construct a multipoint geometry. (but, we want 1 geometry per entry!)

```{r}
sfg <- st_multipoint(as.matrix(buffalo[c("location-long", "location-lat")]))
sfc <- st_geometry(sfg)
st_crs(sfc) <- p4s
```

```{r}
library(sp)
buffalo_sp <- SpatialPointsDataFrame(coords = buffalo[c("location-long", "location-lat")], 
                                     data = buffalo, 
                                     proj4string = sp::CRS(p4s))

sf <- as(buffalo_sp, "sf")

#sf2 <- st_as_sf(buffalo_sp) #identical to above
# sfc <- st_as_sfc(buffalo_sp) # identical to st_geometry(sf)
```


Look at env var layers from <https://www.movebank.org/node/7471>

http://proj4.org/faq.html
